#!/bin/sh

while read Iface Destination Gateway Flags RefCnt Use Metric Mask MTU Window IRTT; do
		[ "$Mask" = "00000000" ] && \
		interface="$Iface" && \
		ipaddr=$(LC_ALL=C /sbin/ip -4 addr list dev "$interface" scope global) && \
		ipaddr=${ipaddr#* inet } && \
		ipaddr=${ipaddr%%/*} && \
		break
done < /proc/net/route

mkdir -p <%= @basic[:libhome] %>/<%= @package[:package] %>

mv <%= @basic[:home] %>/<%= @package[:package] %>/nsqlookupd /etc/systemd/system/nsqlookupd.service
mv <%= @basic[:home] %>/<%= @package[:package] %>/nsqadmin  /etc/systemd/system/nsqadmin.service

chmod 755 /etc/systemd/system/nsqlookupd.service
chmod 755 /etc/systemd/system/nsqadmin.service

cat >> <%= @basic[:libhome] %>/env.sh << EOF
initctl set-env MEGAM_HOME='<%= @basic[:libhome] %>'
initctl set-env MEGAM_NSLOOKUPD_IP="$ipaddr"
EOF

chmod 0755 <%= @basic[:libhome] %>/env.sh

systemctl enable <%= @package[:systemd_nsqd_service] %>

echo "nsqd not yet started. Try manually 'systemctl start nsqd'"
